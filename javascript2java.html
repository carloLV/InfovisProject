<!DOCTYPE html>
<html>
<meta charset="utf-8"/>
<head>
<title> d3 Graph</title>
</head>
<style>
.link {
  stroke: #777;
  stroke-opacity: 0.3;
  stroke-width: 1.5px;
}
.node circle {
  fill: #ccc;
  stroke: #111;
  stroke-width: 1.5px;
}

.node text {
  display: none;
  font: 10px sans-serif;
}

.node:hover circle {
  fill: #000;
}

.node:hover text {
  display: inline;
}
</style>
<body>
<div id="body">
      <div id="chart"></div>
      <div id="header">Creatore di Grafi</div>
    </div>
	<script src="http://d3js.org/d3.v3.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script> //createGraph  graph 
  /*
1- Rimane da modificare i link. é lista di lista quindi va messa tutta in una sola lista per avere tutti i link insieme
*/

d3.text('prova2utenti.json',function(err,data){
  if (err) throw err;
  var links=[];
  var elements = data.split('\n');
  for (var i=0, l=elements.length; i<l; i++){
    links.push(parseLine(elements[i]));
    //console.log(parseLine(elements[i])) //Questi li stampa
  }
  drawMyGraph(computeMyLinks(links));//,computeMyNodes(links));
  //console.log(parseLine(elements[i-1]));pure questo funziona
  //return links;
  });
//}
//This function is applied to each line. It creates data in the map
let parseLine = function(line){
  var obj = JSON.parse(line);
  map = jsonExtractor('info.interests.all',obj); // return the object extracted for this value
  interests = getValuesFromMap(map,['score','name','parents']);
  user = jsonExtractor('user',obj);
  return linkCreator(user,interests);
}
//console.log(window.links); //NON STAMPA NULLA
//var links = linkBuilder();

//Return the value extracted thanks to fields
function jsonExtractor(fields, obj){
    nestedFields = fields.split('.');
    json = obj;
    for (var j=0, lu=nestedFields.length; j<lu; j++) { 
      json=json[nestedFields[j]]
    }
    return json;
}
//Return a list containing all the interests for that user
function getValuesFromMap(obj, attributes){
  var attr=[];
  var interests = [];
  Object.keys(obj).forEach(function(k) {//extracts keys from the map of interests
    var return_value = '';
    return_value += k;
  
  attributes.forEach(function(attr){
    return_value += '-'+attr+':'+obj[k][attr];
  });
  interests.push(return_value);
  });
  //return_value contains following string, then used to create graph and links
  //"581261e892cffb71d2b9783b-score:1-parents:55afc38392cffb786d83f7b5"
  return interests;
}
function linkCreator(key,value){
  var links=[];
  for (var i=0, l=value.length-1; i<l; i++){
    var link = JSON.stringify({source: key, target: value[i].split('-')[0], type: 'user', edge_weight: value[i].split('-')[1].split(':')[1]});
    links.push(link);
    //now we add links between parents
    var parents = value[i].split('-')[3].split(':')[1];
    if (parents){
      var tempList =parents.split(',');
      for (var j=0, len=tempList.length; j<len; j++){
        var link2 = JSON.stringify({source: value[i].split('-')[0], target: parents[j], type: 'parents', edge_weight: 100});
        links.push(link2);
      }
    }
    
  }

  return links;
}


function printLinks(links){
  console.log('stampiamo');
  for (var i=0, l=linkBuilder().length; i<l,i<15; i++)
    console.log(JSON.stringify(links[i]));
}

//Debugging function
function print5links(links){
  for (var i=0, l=5; i<l; i++){
    console.log(JSON.stringify(links[i]));
  }
}

function computeMyLinks(links){
  var myLinks=[];
  links.forEach(function(lk) {//the first iterates on users
    lk.forEach(function(myLink) {//the second iterates on interests
      link=JSON.parse(myLink);
      myLinks.push(link);
    });
  });
  return myLinks;
}

function drawMyGraph(links){//,nodes){
  //console.log(nodes);
  //print5links(links); //ne stampa molti di più
  var nodes = {};

  var w = 1280,
      h = 800;

  links.forEach(function(link) {
    //link=JSON.parse(myLink);
    console.log(link);
    link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
    link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
    });

  var force = d3.layout.force()
      .nodes(d3.values(nodes))
      .links(links)
      .size([w, h])
      //.gravity(0.1)
      .linkDistance(80)
      .charge(-500)
      .on("tick", tick)
      .start();
      

  var svg = d3.select("#chart").append("svg")
      .attr("width", w)
      .attr("height", h);


  var link = svg.selectAll('.link')
        .data(links)
        .enter().append('line')
        .attr('class', 'link');

  var node = svg.selectAll('.node')
        .data(d3.values(nodes))
        .enter().append('g')
        .attr('class','node')
        .call(force.drag);

  var circle = node.append('circle')
      .filter(function(d) { return /^\d+$/.test(d.name) && d.name.length>5})
        .style("fill", "red")
        .attr("r", 6.5);

  var interests = node.append('circle')
      .attr('r', 4.5)
      .filter(function(d) { return !/^\d+$/.test(d.name) && d.name.length>5});
        //.style("fill", "red")
        //.attr("r", 5.5);

  var label = node.append('text')
    .attr('dy','.35em')
    .text(function(d){ return d.name; });

  /*svg.append("svg:rect")
      .attr("width", w)
      .attr("height", h);

  // Per-type markers, as they don't inherit styles.
  svg.append("svg:defs").selectAll("marker")
      .data(["user", "parents", "resolved"])
    .enter().append("svg:marker")
      .attr("id", String)
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 15)
      .attr("refY", -1.5)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
    .append("svg:path")
      .attr("d", "M0,-5L10,0L0,5");

  var path = svg.append("svg:g").selectAll("path")
      .data(force.links())
    .enter().append("svg:path")
      .attr("class", function(d) { return "link " + d.type; })
      .attr("marker-end", function(d) { return "url(#" + d.type + ")"; });
  */


  /*var circle = svg.append("svg:g").selectAll("circle")
      .data(force.nodes())
    .enter().append("svg:circle")
      .attr("r", 8)
      .call(force.drag);

  var text = svg.append("svg:g").selectAll("g")
      .data(force.nodes())
      .on("mouseover", mouseover)
      .on("mouseout", mouseout)
    .enter().append("svg:g");

  // A copy of the text with a thick white stroke for legibility.
  text.append("svg:text")
      .attr("x", 12)
      .attr("y", ".31em")
      .attr("class", "shadow")
      .text(function(d) { return d.name; });

  text.append("svg:text")
      .attr("x", 12)
      .attr("y", ".31em")
      .text(function(d) { return d.name; });
      */

  // Use elliptical arc path segments to doubly-encode directionality.
  function tick() {
    /*path.attr("d", function(d) {
      var dx = d.target.x - d.source.x,
          dy = d.target.y - d.source.y,
          dr = Math.sqrt(dx * dx + dy * dy);
      return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
    });*/
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    circle
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });

     interests
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });

    label
        .attr("x", function(d) { return d.x + 8; })
        .attr("y", function(d) { return d.y; });

    /*
    circle.attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    });

    text.attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    });*/
  }

  function mouseover(){
    d3.select(this).select("text").style("visibility", "visible");
    /*d3.selectAll('.link').style('stroke-width', function(l) {
      console.log(d3.select(this).select("text"));
    if (d3.select(this).select("text") == l.source || d3.select(this).select("text") == l.target)
      return 8;
    else
      return 2;
    });*/
  }
  function mouseout(){
    d3.select(this).select("text").style("visibility", "hidden");
    //d3.selectAll('.link').style('stroke-width', 2);
  }

}

/*
.link:hover{
  stroke: blue;
  stroke-width: 3.5px;
}

*/
	</script>
	</body>
</html>

